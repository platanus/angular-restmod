/**
 * API Bound Models for AngularJS
 * @version v0.11.1 - 2014-01-22
 * @link https://github.com/angular-platanus/restmod
 * @author Ignacio Baixas <iobaixas@gmai.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){"use strict";a.module("plRestmod",["ng","platanus.inflector"]);var c={chain:function(a,b){return a?function(c){return b.call(this,a.call(this,c))}:b},override:function(a,b){return a&&"function"==typeof b?function(){var c=this.$super;try{return this.$super=a,b.apply(this,arguments)}finally{this.$super=c}}:b},extendOverriden:function(a,b){for(var d in b)b.hasOwnProperty(d)&&(a[d]=c.override(a[d],b[d]))}};a.module("plRestmod").constant("Utils",c);var d={NONE:0,ALL:65535,SYSTEM_ALL:131071,SYSTEM:65536,DECODE_CREATE:1,DECODE_UPDATE:2,DECODE_USER:4,DECODE_SAVE:3,ENCODE_CREATE:256,ENCODE_UPDATE:512,ENCODE_USER:1024,ENCODE_SAVE:768,DECODE:255,ENCODE:65280,CREATE:257,UPDATE:514,USER:1028,SAVE:771},e=a.bind,f=a.forEach,g=a.extend,h=a.isObject,i=a.isArray,j=a.isFunction,k=Array.prototype.slice;a.module("plRestmod").provider("$restmod",function(){var l=[];return{pushModelBase:function(){return Array.prototype.push.apply(l,arguments),this},$get:["$http","$q","$injector","$parse","$filter","$inflector",function(m,n,o,p,q,r){var s={model:function(s){function t(a,b){var c,d,e,f;if(c=F[a])for(e=k.call(arguments,2),d=0;f=c[d];d++)f.apply(b,e);if(b.$cb&&(c=b.$cb[a]))for(e||(e=k.call(arguments,2)),d=0;f=c[d];d++)f.apply(b,e)}function u(a,b,c,d){t("before-request",a,b),a.$pending=!0,a.$response=null,a.$error=!1,a.$promise=m(b).then(function(b){return a.$pending=!1,a.$response=b,t("after-request",a,b),c&&c.call(a,b),a},function(b){return a.$pending=!1,a.$response=b,a.$error=!0,t("after-request-error",a,b),d&&d.call(a,b),n.reject(a)})}function v(a,c,d,e,f,g){var h,i,j,k,l,m,n=g||{};for(h in a)if(a.hasOwnProperty(h)&&(i=f&&G?G(h):h,k=d+i,!((B[k]||0)&e))){if(m=a[h],l=f?D[k]:E[k]){if(m=l.call(c,m),m===b)continue}else"object"==typeof m&&m&&(f||"function"!=typeof m.toJSON)&&(m=w(m,c,k,e,f));j=!f&&H?H(i):i,n[j]=m}return n}function w(a,b,c,d,e){if(i(a)){var f,g,h,j=c+"[]",k=e?D[j]:E[j],l=[];for(f=0,g=a.length;g>f;f++)h=a[f],k?h=k.call(b,h):"object"==typeof h&&h&&(e||"function"!=typeof h.toJSON)&&(h=w(h,b,c,d,e)),l.push(h);return l}return v(a,b,c+".",d,e)}function x(a,b){return a&&b?(a+"").replace(/\/$/,"")+"/"+(b+"").replace(/(\/$|^\/)/g,""):null}function y(a,b){this.$scope=a,this.$pk=b,this.$pending=!1,this.$type=y;for(var c,d=0;c=C[d];d++)this[c[0]]="function"==typeof c[1]?c[1].apply(this):c[1];t("after-init",this)}function z(a){for(var b=0,c=a.length;c>b;b++)A(a[b])}function A(a){a.$chain?z(a.$chain):"string"==typeof a?A(o.get(a)):i(a)||j(a)?o.invoke(a,K,{$builder:K}):K.describe(a)}var B={$type:d.SYSTEM_ALL,$scope:d.SYSTEM_ALL,$promise:d.SYSTEM_ALL,$pending:d.SYSTEM_ALL,$response:d.SYSTEM_ALL,$error:d.SYSTEM_ALL,$cb:d.SYSTEM_ALL},C=[],D={},E={},F={},G=r.camelize,H=function(a){return r.parameterize(a,"_")};y.$single=function(a){return new y({$urlFor:function(){return a}},"")},y.inferKey=function(a){return"object"==typeof a?"undefined"==typeof a.id?null:a.id:a},y.$$setMask=function(a,b){B[a]=b},y.$$registerHook=function(a,b){var c=F[a];return c||(c=F[a]=[]),c.push(b),this},y.prototype={$url:function(){return this.$scope.$urlFor(this)},$buildScope:function(a,b){if(!a.$buildOwnScope){var c=this;return{$urlFor:function(){return x(c.$url(!0),b)},$createUrlFor:function(){return null},$updateUrlFor:function(b){return a.$urlFor(b)||this.$urlFor()},$destroyUrlFor:function(b){return a.$baseUrl?a.$urlFor(b):this.$urlFor()}}}},$extend:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);return this},$each:function(a,c,e){c===b&&(c=d.SYSTEM);for(var f in this)this.hasOwnProperty(f)&&((B[f]||0)&c||a.call(e||this[f],this[f],f));return this},$callback:function(a){return t(a,this,k.call(arguments,1)),this},$on:function(a,b){var c=(this.$cb||(this.$cb={}))[a]||(this.$cb[a]=[]);return c.push(b),this},$send:function(a,b,c){return u(this,a,b,c),this},$then:function(a,b){return this.$promise=this.$promise.then(a,b),this},$finally:function(a){return this.$promise=this.$promise["finally"](a),this},$decode:function(a,b){return v(a,this,"",b||d.DECODE_USER,!0,this),this.$pk||(this.$pk=y.inferKey(a)),t("after-feed",this,a),this},$encode:function(a){var b=v(this,this,"",a||d.ENCODE_USER,!1);return t("before-render",this,b),b},$fetch:function(){var a=this.$url();if(!a)throw new Error("Cannot fetch an unbound resource");var b={method:"GET",url:a};return t("before-fetch",this,b),this.$send(b,function(a){var b=a.data;if(!b||i(b))throw new Error("Expected object while feeding resource");this.$decode(b),t("after-fetch",this,a)},function(a){t("after-fetch-error",this,a)})},$save:function(){var a,b=this.$scope.$updateUrlFor?this.$scope.$updateUrlFor(this):this.$url();if(b)return a={method:"PUT",url:b,data:this.$encode(d.ENCODE_UPDATE)},t("before-update",this,a),t("before-save",this,a),this.$send(a,function(a){var b=a.data;b&&!i(b)&&this.$decode(b,d.DECODE_UPDATE),t("after-update",this,a),t("after-save",this,a)},function(a){t("after-update-error",this,a),t("after-save-error",this,a)});if(b=this.$scope.$createUrlFor&&this.$scope.$createUrlFor(this)||this.$scope.$url&&this.$scope.$url(),!b)throw new Error("Create is not supported by this resource");return a={method:"POST",url:b,data:this.$encode(d.ENCODE_CREATE)},t("before-save",this,a),t("before-create",this,a),this.$send(a,function(a){var b=a.data;b&&!i(b)&&this.$decode(b,d.DECODE_CREATE),t("after-create",this,a),t("after-save",this,a)},function(a){t("after-create-error",this,a),t("after-save-error",this,a)})},$destroy:function(){var a=this.$scope.$destroyUrlFor?this.$scope.$destroyUrlFor(this):this.$url();if(!a)throw new Error("Cannot destroy an unbound resource");var b={method:"DELETE",url:a};return t("before-destroy",this,b),this.$send(b,function(a){this.$scope.$remove&&this.$scope.$remove(this),t("after-destroy",this,a)},function(a){t("after-destroy-error",this,a)})}};var I={$baseUrl:s,$url:function(){return this.$scope?this.$scope.$urlFor(this):this.$baseUrl},$urlFor:function(a){return x(this.$baseUrl?this.$baseUrl:this.$url(),a.$pk)},$callback:function(a){return t(a,this,k.call(arguments,1)),this},$on:function(a,b){var c=(this.$cb||(this.$cb={}))[a]||(this.$cb[a]=[]);return c.push(b),this},$new:function(a){return new y(this,a)},$build:function(b){var c=this.$new(y.inferKey(b));return a.extend(c,b),this.$isCollection&&this.$add(c),c},$buildRaw:function(a){var b=this.$new(y.inferKey(a));return b.$decode(a),this.$isCollection&&this.$add(b),b},$find:function(a){return this.$new(y.inferKey(a)).$fetch()},$create:function(a){return this.$build(a).$save()},$collection:function(a,b){var c=[];for(var d in I)this.hasOwnProperty(d)&&(c[d]=this[d]);return c.$isCollection=!0,c.$scope=b||this.$scope,c.$params=this.$params?g({},this.$params,a):a,c.$pending=!1,c.$resolved=!1,c},$search:function(a){return this.$collection(a).$fetch()},$then:function(a,b){if(!this.$isCollection)throw new Error("$then is only supported by collections");return this.$promise=this.$promise.then(a,b),this},$finally:function(a){return this.$promise=this.$promise["finally"](a),this},$feed:function(a){if(!this.$isCollection)throw new Error("$feed is only supported by collections");return this.$resolved||(this.length=0),f(a,this.$buildRaw,this),this.$resolved=!0,this},$reset:function(){if(!this.$isCollection)throw new Error("$reset is only supported by collections");return this.$resolved=!1,this},$fetch:function(a){if(!this.$isCollection)throw new Error("$fetch is only supported by collections");var b=a?g({},this.$params||{},a):this.$params,c={method:"GET",url:this.$url(),params:b};return t("before-fetch-many",this,c),u(this,c,function(a){var b=a.data;if(!b||!i(b))throw new Error("Error in resource {0} configuration. Expected response to be array");this.$feed(b),t("after-fetch-many",this,a)},function(a){t("after-fetch-many-error",this,a)}),this},$refresh:function(a){return this.$reset().$fetch(a)},$add:function(a,b){return this.$isCollection&&("undefined"!=typeof b?this.splice(b,0,a):this.push(a),t("after-add",this,a)),this},$remove:function(a){var b=this.$indexOf(a);return-1!==b&&(this.splice(b,1),t("after-remove",this,a)),this},$indexOf:function(a){var b="function"==typeof a?a:!1;if(this.$isCollection)for(var c=0,d=this.length;d>c;c++)if(b?b(this[c]):this[c]===a)return c;return-1}},J={init:["attrDefault"],mask:["attrMask"],ignore:["attrMask"],decode:["attrDecoder","param","chain"],encode:["attrEncoder","param","chain"],serialize:["attrSerializer"],hasMany:["attrAsCollection","path","source","inverseOf"],hasOne:["attrAsResource","path","source","inverseOf"],belongsTo:["attrAsReference","inline","key","source","prefetch"]},K={setHttpOptions:function(){},setNameDecoder:function(a){return G=a,this},setNameEncoder:function(a){return H=a,this},setKeyProvider:function(a){return y.inferKey=a,this},disableRenaming:function(){return this.setNameDecoder(!1).setNameEncoder(!1)},extend:function(a,b,d){return"string"==typeof a?(this[a]=c.override(this[name],b),d&&(J[d[0]]=d,d[0]=a)):c.extendOverriden(this,a),this},describe:function(a){return f(a,function(a,b){switch(b[0]){case"@":this.classDefine(b.substring(1),a);break;case"~":b=r.parameterize(b.substring(1)),this.on(b,a);break;default:h(a)?this.attribute(b,a):j(a)?this.define(b,a):this.attrDefault(b,a)}},this),this},attribute:function(a,b){var c,d,e,f;for(c in b)if(b.hasOwnProperty(c)&&(d=J[c])){for(e=[a,b[c]],f=1;f<d.length;f++)e.push(b[d[f]]);e.push(b),this[d[0]].apply(this,e)}return this},attrDefault:function(a,b){return C.push([a,b]),this},attrMask:function(a,b,c){return b===!0?B[a]=d.ALL:b===!1?delete B[a]:c?B[a]=b:B[a]|=b,this},attrSerializer:function(a,b,c){return"string"==typeof b&&(b=o.get(r.camelize(b,!0)+"Serializer")),j(b)&&(b=b(c)),b.decode&&this.attrDecoder(a,e(b,b.decode)),b.encode&&this.attrEncoder(a,e(b,b.encode)),this},attrDecoder:function(a,b,d,e){if("string"==typeof b){var f=q(b);b=function(a){return f(a,d)}}return D[a]=e?c.chain(D[a],b):b,this},attrEncoder:function(a,b,d,e){if("string"==typeof b){var f=q(b);b=function(a){return f(a,d)}}return E[a]=e?c.chain(E[a],b):b,this},attrAsCollection:function(a,b,c,e,f){return this.attrDefault(a,function(){"string"==typeof b&&(b=o.get(b),f&&b.$$setMask(f,d.ENCODE));var e=this,g=this.$buildScope(b,c||r.parameterize(a)),h=b.$collection(null,g);return f&&h.$on("after-add",function(a){a[f]=e}),h}).attrDecoder(e||c||a,function(b){this[a].$feed(b)}).attrMask(a,d.ENCODE)},attrAsResource:function(a,b,c,e,f){return this.attrDefault(a,function(){"string"==typeof b&&(b=o.get(b),f&&b.$$setMask(f,d.ENCODE));var e=this.$buildScope(b,c||r.parameterize(a)),g=new b(e);return f&&(g[f]=this),g}).attrDecoder(e||c||a,function(b){this[a].$decode(b)}).attrMask(a,d.ENCODE)},attrAsReference:function(a,b,c,e,f,g){var h=c?f||a:e||a+"Id";this.attrDefault(a,null).attrMask(a,d.ENCODE).attrDecoder(h,function(d){"string"==typeof b&&(b=o.get(b)),c?this[a]&&this[a].$pk===b.inferKey(d)?this[a].$decode(d):this[a]=b.$buildRaw(d):this[a]&&this[a].$pk===d||(this[a]=b.$build(d),g&&this[a].$fetch())})},define:function(a,b){return"string"==typeof a?y.prototype[a]=c.override(y.prototype[a],b):c.extendOverriden(y.prototype,a),this},classDefine:function(a,b){return"string"==typeof a?I[a]=c.override(I[a],b):c.extendOverriden(I,a),this},on:function(a,b){return y.$$registerHook(a,b),this},attrExpression:function(a,b){var c=p(b);this.on("after-feed",function(){this[a]=c(this)})}};return z(l),z(y.$chain=k.call(arguments,1)),g(y,I),y},mixin:function(){return{$isAbstract:!0,$chain:k.call(arguments,0)}},singleton:function(a){return s.model.apply(this,arguments).$single(a)}};return s}]}}).factory("model",["$restmod",function(a){return a.model}]).factory("mixin",["$restmod",function(a){return a.mixin}]).constant("SyncMask",d)}(angular);